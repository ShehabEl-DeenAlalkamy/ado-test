parameters:
  - name: env
    type: string
    default: ""

  - name: stageName
    default: ""
    type: string

  - name: stageDisplayName
    default: ""
    type: string

  - name: buildReason
    default: ""
    type: string

  - name: isTargetBranch
    default: true
    type: boolean

stages:
  - stage: ${{ parameters.stageName }}
    displayName: ${{ parameters.stageDisplayName }}
    condition: and(always(), eq(variables['Build.Reason'], '${{ parameters.buildReason }}'), ${{ parameters.isTargetBranch }})
    variables:
      - template: vars/vars-${{ parameters.env }}.yml
    jobs:
      - job: TestJob
        displayName: Test Job
        steps:
          - script: |
              echo 'stagename        : ${{ variables.stageName }}'
              echo 'stagedisplayname : ${{ variables.stageDisplayName }}'
              echo 'namespace        : ${{ variables.namespace }}'
              echo 'buildreason      : ${{ variables.buildReason }}'
              echo 'istargetbranch   : ${{ variables.isTargetBranch }}'
            displayName: Logging File Variables

      # - job: TestJob2
      #   displayName: Test Job2
      #   dependsOn: TestJob
      #   steps:
      #     - script: |
      #         echo 'stagename        : ${{ variables.stageName }}'
      #         echo 'stagedisplayname : ${{ variables.stageDisplayName }}'
      #         echo 'namespace        : ${{ variables.namespace }}'
      #         echo 'buildreason      : ${{ variables.buildReason }}'
      #         echo 'istargetbranch   : ${{ variables.isTargetBranch }}'
      #       displayName: Logging File Variables

      # - job: TestJob3
      #   displayName: Test Job3
      #   dependsOn: TestJob2
      #   steps:
      #     - script: |
      #         echo 'stagename        : ${{ variables.stageName }}'
      #         echo 'stagedisplayname : ${{ variables.stageDisplayName }}'
      #         echo 'namespace        : ${{ variables.namespace }}'
      #         echo 'buildreason      : ${{ variables.buildReason }}'
      #         echo 'istargetbranch   : ${{ variables.isTargetBranch }}'
      #       displayName: Logging File Variables                        

      - job: Test
        displayName: Test
        steps:
          - template: steps/maven-test.yml
            parameters:
              vars: ${{ variables }}

      # - job: Build
      #   displayName: Build
      #   dependsOn: Test
      #   steps:
      #     - template: steps/maven-build.yml
      #     - template: steps/artifacts.yml

      # - job: Deploy
      #   displayName: Deploy
      #   dependsOn:
      #     - Test
      #     - Build
      #   steps:
      #     - template: steps/deploy-to-k8s.yml

      # - job: TestFailureHandling
      #   displayName: Error Handling
      #   dependsOn:
      #     - Test
      #     - Build
      #   condition: failed()
      #   steps:
      #     - template: steps/send-notifications-to-team.yml

  # - stage: ${{ variables.stageName }}
  #   displayName: ${{ variables.stageDisplayName }}
  #   condition: and(always(), eq(variables['Build.Reason'], '${{ variables.buildReason }}'), ${{ variables.isTargetBranch }})
  #   variables:
  #     - template: vars/vars-${{ parameters.environment }}.yml
  #   jobs:
  #     - job: Test
  #       displayName: Test
  #       steps:
  #         - script: exit 1

  #     - job: BuildAndDeploy
  #       displayName: Build & Depoly
  #       dependsOn: Test
  #       steps:
  #         - script: echo Build Image
  #         - script: echo Push Image
  #         - script: echo Deploy to ${{ variables.namespace }}
  #         - script: echo RollBack

  #     - job: SendErrorNotification
  #       displayName: Send Error Notification
  #       dependsOn: Test
  #       condition: failed()
  #       steps:
  #         - script: echo Sending Notification to Development Team
